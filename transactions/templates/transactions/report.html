{% extends 'base.html' %}
{% block content %}
<style>
    canvas {
        max-width: 100%;
        height: auto;
    }
</style>

<div class="container mt-5">
    <h2 class="text-center mb-4">My Financial Report</h2>

    {% if warnings %}
      <div class="alert alert-warning mt-3">
        <strong>âš  Budget Alert:</strong>
        <ul class="mb-0">
          {% for warning in warnings %}
            <li>{{ warning }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    <!-- Insight Summary -->
    <div id="insightSummary" class="alert alert-info text-center d-none">
        You spent <strong id="totalSpent">$X</strong> in the selected period.
        Your top expense was <strong id="topCategory">Category</strong>.
        <span id="basicTip">Try limiting spending in this category to save!</span>
    </div>

    <!-- Graph Reports Section -->
    <div class="card shadow mb-5">
        <div class="card-body">
            <div class="text-center mb-4">
                <h4>Graphical Reports</h4>
                <div class="d-flex flex-row align-items-center justify-content-between">
                    <div style="width: 33%;"></div>

                    <div class="d-flex gap-3 justify-content-center" style="width: 33%;">
                        <button class="btn btn-primary" onclick="loadReportData('all')">All Time</button>
                        <button class="btn btn-secondary" onclick="loadReportData('3months')">Last 3 Months</button>
                    </div>
                    <div class="d-flex justify-content-end" style="width: 33%;">
                        <button id="share-button" class="btn btn-primary">Share</button>
                    </div>
                </div>
            </div>

            <div id="makepdf" class="row">
                <!-- Pie Chart Card -->
                <div class="col-md-6 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-header text-center fw-bold">
                            Spending by Category
                        </div>
                        <div class="card-body text-center">
                            <canvas id="pieChart" width="350" height="350"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Line Chart Card -->
                <div class="col-md-6 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-header text-center fw-bold">
                            Monthly Spending Trends
                        </div>
                        <div class="card-body text-center">
                            <canvas id="lineChart" width="350" height="350"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js Script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let pieChartInstance;
let lineChartInstance;

let user;

function loadReportData(timeRange = "all") {
    fetch("{% url 'user-report-data' %}?range=" + timeRange + "&t=" + new Date().getTime())
    .then(response => response.json())
    .then(data => {
        if (pieChartInstance) pieChartInstance.destroy();
        if (lineChartInstance) lineChartInstance.destroy();
        user = data.report_user // storing user for sharing feature later

        const pieCtx = document.getElementById('pieChart').getContext('2d');
        pieChartInstance = new Chart(pieCtx, {
            type: 'pie',
            data: {
                labels: data.category_data.map(c => c.category),
                datasets: [{
                    data: data.category_data.map(c => c.total),
                    backgroundColor: ['#4e79a7', '#f28e2b', '#e15759', '#76b7b2', '#59a14f'],
                }]
            },
            options: {
                animation: {
                    duration: 1200,
                    easing: 'easeInOutCubic'
                }
            }
        });

        const lineCtx = document.getElementById('lineChart').getContext('2d');
        lineChartInstance = new Chart(lineCtx, {
            type: 'line',
            data: {
                labels: Object.keys(data.monthly_data),
                datasets: [{
                    label: 'Monthly Spending',
                    data: Object.values(data.monthly_data),
                    fill: false,
                    borderColor: '#4e79a7',
                    tension: 0.3
                }]
            },
            options: {
                animation: {
                    duration: 1200,
                    easing: 'easeInOutCubic'
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        let totalSpent = 0;
        let topCategory = '';
        let maxSpent = 0;

        data.category_data.forEach(entry => {
            totalSpent += entry.total;
            if (entry.total > maxSpent) {
                maxSpent = entry.total;
                topCategory = entry.category;
            }
        });

        document.getElementById('totalSpent').textContent = `$${totalSpent.toFixed(2)}`;
        document.getElementById('topCategory').textContent = topCategory;
        document.getElementById('basicTip').textContent =
            `Try limiting your ${topCategory.toLowerCase()} spending to save more in this period.`;

        document.getElementById('insightSummary').classList.remove('d-none');
    });
}

loadReportData("all");

// sharing feature
let button = document.getElementById("share-button");
let makepdf = document.getElementById("makepdf");

button.addEventListener("click", () => {

    const pieChartImgData = pieChartInstance.toBase64Image();
    const lineChartImgData = lineChartInstance.toBase64Image();

    let contentToPrint = makepdf.cloneNode(true);

    let pieCanvas = contentToPrint.querySelector('#pieChart');
    let lineCanvas = contentToPrint.querySelector('#lineChart');

    let pieImg = document.createElement('img');
    pieImg.src = pieChartImgData;
    pieImg.style.maxWidth = '50%'; // Maintain responsiveness
    pieImg.style.height = 'auto';

    let lineImg = document.createElement('img');
    lineImg.src = lineChartImgData;
    lineImg.style.maxWidth = '50%'; // Maintain responsiveness
    lineImg.style.height = 'auto';

    pieCanvas.parentNode.replaceChild(pieImg, pieCanvas);
    lineCanvas.parentNode.replaceChild(lineImg, lineCanvas);

    let htmlToPrint = `
        <html>
        <head>
        <link rel="stylesheet" type="text/css" href="static/css/style.css" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
        </head>
        <body>
            <div class="d-flex justify-content-center">
                Financial Report for ${user}
            </div>
        ${contentToPrint.innerHTML}
        </body>
        </html>
    `
    let myWindow = window.open("", "PRINT", "height=600,width=800"); // Adjust size as needed
    myWindow.document.write(htmlToPrint);
    myWindow.document.close();

    setTimeout(() => {
        myWindow.focus();
        myWindow.print();
        myWindow.close();
    }, 500)
    return true;
})
</script>
{% endblock %}
